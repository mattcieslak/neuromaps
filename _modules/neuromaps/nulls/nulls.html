<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>neuromaps.nulls.nulls &mdash; neuromaps 0+untagged.1.g47ea75f documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-rendered-html.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/neuromaps_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0+untagged.1.g47ea75f
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation and setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">User guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing a new brain map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../citing.html">Citing neuromaps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">Reference API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">neuromaps</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">neuromaps.nulls.nulls</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for neuromaps.nulls.nulls</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Contains functionality for running spatial null models</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">cdist</span>
<span class="kn">from</span> <span class="nn">packaging</span> <span class="kn">import</span> <span class="n">version</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">brainsmash</span>
    <span class="kn">from</span> <span class="nn">brainsmash.mapgen</span> <span class="kn">import</span> <span class="n">Base</span><span class="p">,</span> <span class="n">Sampled</span>
    <span class="n">_brainsmash_avail</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_brainsmash_avail</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">brainspace.null_models.moran</span> <span class="kn">import</span> <span class="n">MoranRandomization</span>
    <span class="n">_brainspace_avail</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_brainspace_avail</span> <span class="o">=</span> <span class="kc">False</span>

<span class="kn">from</span> <span class="nn">neuromaps.datasets</span> <span class="kn">import</span> <span class="n">fetch_atlas</span>
<span class="kn">from</span> <span class="nn">neuromaps.datasets.atlases</span> <span class="kn">import</span> <span class="n">_sanitize_atlas</span>
<span class="kn">from</span> <span class="nn">neuromaps.images</span> <span class="kn">import</span> <span class="n">load_data</span><span class="p">,</span> <span class="n">load_nifti</span><span class="p">,</span> <span class="n">PARCIGNORE</span>
<span class="kn">from</span> <span class="nn">neuromaps.points</span> <span class="kn">import</span> <span class="n">get_surface_distance</span>
<span class="kn">from</span> <span class="nn">neuromaps.transforms</span> <span class="kn">import</span> <span class="n">mni152_to_mni152</span>
<span class="kn">from</span> <span class="nn">neuromaps.nulls.burt</span> <span class="kn">import</span> <span class="n">batch_surrogates</span>
<span class="kn">from</span> <span class="nn">neuromaps.nulls.spins</span> <span class="kn">import</span> <span class="p">(</span><span class="n">gen_spinsamples</span><span class="p">,</span> <span class="n">get_parcel_centroids</span><span class="p">,</span>
                                   <span class="n">load_spins</span><span class="p">,</span> <span class="n">spin_data</span><span class="p">,</span> <span class="n">spin_parcels</span><span class="p">)</span>
<span class="n">HEMI</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="n">lh</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="n">rh</span><span class="o">=</span><span class="s1">&#39;R&#39;</span><span class="p">)</span>


<span class="n">_nulls_input_docs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">data_or_none_surface</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">data : array_like or path_like or giimg_like or tuple</span>
<span class="s2">    Input data from which to generate null maps. If None is provided then</span>
<span class="s2">    the resampling array will be returned instead. When a parcellation is</span>
<span class="s2">    provided, the data must be parcellated and array-like. Otherwise, the data</span>
<span class="s2">    must be a surface-based image (giimg_like, e.g. nib.GiftiImage) or a</span>
<span class="s2">    path-like object (`str` or `os.PathLike`) pointing to an image file.</span><span class="se">\</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">data_or_none_parcel</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">data : (N,) array_like</span>
<span class="s2">    Input data from which to generate null maps. The data must be</span>
<span class="s2">    parcellated and array-like. If None is provided then the resampling array</span>
<span class="s2">    will be returned instead.</span><span class="se">\</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">data_parcel</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">data : (N,) array_like</span>
<span class="s2">    Input data from which to generate null maps. The data must be</span>
<span class="s2">    parcellated and array-like.</span><span class="se">\</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">data : array_like or path_like or niimg_like or giimg_like or tuple</span>
<span class="s2">    Input data from which to generate null maps. When a parcellation is</span>
<span class="s2">    provided, the data must be parcellated and array-like. Otherwise, the data</span>
<span class="s2">    can either be a volumetric image (niimg_like, e.g. nib.Nifti1Image) or a</span>
<span class="s2">    surface-based image (giimg_like, e.g. nib.GiftiImage). Alternatively, it</span>
<span class="s2">    can be a path-like object (`str` or `os.PathLike`) pointing to an image</span>
<span class="s2">    file.</span><span class="se">\</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">atlas_density_surface</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">atlas : {&#39;fsLR&#39;, &#39;fsaverage&#39;, &#39;civet&#39;}, optional</span>
<span class="s2">    Name of surface atlas on which `data` are defined. Default: &#39;fsaverage&#39;</span>
<span class="s2">density : str, optional</span>
<span class="s2">    Density of surface mesh on which `data` are defined. Must be</span>
<span class="s2">    compatible with specified `atlas`. Default: &#39;10k&#39;</span><span class="se">\</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">atlas_density</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">atlas : {&#39;fsLR&#39;, &#39;fsaverage&#39;, &#39;civet&#39;, &#39;mni152&#39;}, optional</span>
<span class="s2">    Name of atlas on which `data` are defined. Default: &#39;fsaverage&#39;</span>
<span class="s2">density : str, optional</span>
<span class="s2">    Density of atlas on which `data` are defined. Must be</span>
<span class="s2">    compatible with specified `atlas`. Default: &#39;10k&#39;</span><span class="se">\</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">parcellation</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">parcellation : tuple-of-str or os.PathLike, optional</span>
<span class="s2">    Filepaths to parcellation images ([left, right] hemisphere) mapping `data`</span>
<span class="s2">    to atlas specified by `atlas` and `density`. Should only be supplied</span>
<span class="s2">    if `data` represents a parcellated null map. Default: None</span><span class="se">\</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">n_perm</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">n_perm : int, optional</span>
<span class="s2">    Number of null maps or permutations to generate. Default: 1000</span><span class="se">\</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">seed : {int, np.random.RandomState instance, None}, optional</span>
<span class="s2">    Seed for random number generation. Default: None</span><span class="se">\</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">spins</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">spins : array_like or str or os.PathLike</span>
<span class="s2">    Filepath to or pre-loaded resampling array. If not specified spins are</span>
<span class="s2">    generated. Default: None</span><span class="se">\</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">surfaces</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">surfaces : tuple-of-str or os.PathLike, optional</span>
<span class="s2">    Instead of specifying `atlas` and `density` this specifies the surface</span>
<span class="s2">    files on which `data` are defined. Providing this will override arguments</span>
<span class="s2">    supplied to `atlas` and `density`. Default: None</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">n_proc</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">n_proc : int, optional</span>
<span class="s2">    Number of processors to use for parallelizing computations. If negative</span>
<span class="s2">    will use max available processors plus 1 minus the specified number.</span>
<span class="s2">    Default: 1 (no parallelization)</span><span class="se">\</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">distmat</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">distmat : tuple-of-str or os.PathLike, optional</span>
<span class="s2">    Filepaths to pre-computed (left, right) surface distance matrices.</span>
<span class="s2">    Providing this will cause `atlas`, `density`, and `parcellation` to be</span>
<span class="s2">    ignored. Default: None</span><span class="se">\</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">kwargs</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">kwargs : key-value pairs</span>
<span class="s2">    Other keyword arguments passed directly to the underlying null method</span>
<span class="s2">    generator</span><span class="se">\</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">nulls</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">nulls : np.ndarray</span>
<span class="s2">    Generated null distribution, where each column represents a unique null</span>
<span class="s2">    map</span><span class="se">\</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="p">)</span>


<div class="viewcode-block" id="alexander_bloch"><a class="viewcode-back" href="../../../generated/neuromaps.nulls.alexander_bloch.html#neuromaps.nulls.alexander_bloch">[docs]</a><span class="k">def</span> <span class="nf">alexander_bloch</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="s1">&#39;fsaverage&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="s1">&#39;10k&#39;</span><span class="p">,</span> <span class="n">parcellation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">n_perm</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">surfaces</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">spins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">surfaces</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">surfaces</span> <span class="o">=</span> <span class="n">fetch_atlas</span><span class="p">(</span><span class="n">atlas</span><span class="p">,</span> <span class="n">density</span><span class="p">)[</span><span class="s1">&#39;sphere&#39;</span><span class="p">]</span>
        <span class="n">coords</span><span class="p">,</span> <span class="n">hemi</span> <span class="o">=</span> <span class="n">get_parcel_centroids</span><span class="p">(</span><span class="n">surfaces</span><span class="p">,</span>
                                            <span class="n">parcellation</span><span class="o">=</span><span class="n">parcellation</span><span class="p">,</span>
                                            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;surface&#39;</span><span class="p">)</span>
        <span class="n">spins</span> <span class="o">=</span> <span class="n">gen_spinsamples</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">hemi</span><span class="p">,</span> <span class="n">n_rotate</span><span class="o">=</span><span class="n">n_perm</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">spins</span> <span class="o">=</span> <span class="n">load_spins</span><span class="p">(</span><span class="n">spins</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spins</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">load_data</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="n">spins</span><span class="p">]</span></div>


<span class="n">alexander_bloch</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Generates null maps from `data` using method from [SN1]_</span>

<span class="s2">Method projects data to a spherical surface and uses arbitrary rotations to</span>
<span class="s2">generate null distribution. If `data` are parcellated then parcel centroids</span>
<span class="s2">are projected to surface and parcels are reassigned based on minimum distances.</span>

<span class="s2">Parameters</span>
<span class="s2">----------</span>
<span class="si">{data_or_none_surface}</span>
<span class="si">{atlas_density_surface}</span>
<span class="si">{parcellation}</span>
<span class="si">{n_perm}</span>
<span class="si">{seed}</span>
<span class="si">{spins}</span>
<span class="si">{surfaces}</span>

<span class="s2">Returns</span>
<span class="s2">-------</span>
<span class="si">{nulls}</span>

<span class="s2">References</span>
<span class="s2">----------</span>
<span class="s2">.. [SN1] Alexander-Bloch, A., Shou, H., Liu, S., Satterthwaite, T. D.,</span>
<span class="s2">   Glahn, D. C., Shinohara, R. T., Vandekar, S. N., &amp; Raznahan, A. (2018).</span>
<span class="s2">   On testing for spatial correspondence between maps of human brain</span>
<span class="s2">   structure and function. NeuroImage, 178, 540-51.</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">_nulls_input_docs</span><span class="p">)</span>


<span class="n">vazquez_rodriguez</span> <span class="o">=</span> <span class="n">alexander_bloch</span>


<div class="viewcode-block" id="vasa"><a class="viewcode-back" href="../../../generated/neuromaps.nulls.vasa.html#neuromaps.nulls.vasa">[docs]</a><span class="k">def</span> <span class="nf">vasa</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="s1">&#39;fsaverage&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="s1">&#39;10k&#39;</span><span class="p">,</span> <span class="n">parcellation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
         <span class="n">n_perm</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">surfaces</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">parcellation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot use `vasa()` null method without specifying &#39;</span>
                         <span class="s1">&#39;a parcellation. Use `alexander_bloch() instead if &#39;</span>
                         <span class="s1">&#39;working with unparcellated surface data.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">surfaces</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">surfaces</span> <span class="o">=</span> <span class="n">fetch_atlas</span><span class="p">(</span><span class="n">atlas</span><span class="p">,</span> <span class="n">density</span><span class="p">)[</span><span class="s1">&#39;sphere&#39;</span><span class="p">]</span>
        <span class="n">coords</span><span class="p">,</span> <span class="n">hemi</span> <span class="o">=</span> <span class="n">get_parcel_centroids</span><span class="p">(</span><span class="n">surfaces</span><span class="p">,</span>
                                            <span class="n">parcellation</span><span class="o">=</span><span class="n">parcellation</span><span class="p">,</span>
                                            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;surface&#39;</span><span class="p">)</span>
        <span class="n">spins</span> <span class="o">=</span> <span class="n">gen_spinsamples</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">hemi</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;vasa&#39;</span><span class="p">,</span> <span class="n">n_rotate</span><span class="o">=</span><span class="n">n_perm</span><span class="p">,</span>
                                <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">spins</span> <span class="o">=</span> <span class="n">load_spins</span><span class="p">(</span><span class="n">spins</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spins</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">load_data</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="n">spins</span><span class="p">]</span></div>


<span class="n">vasa</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Generates null maps for parcellated `data` using method from [SN2]_</span>

<span class="s2">Method projects parcels to a spherical surface and uses arbitrary rotations</span>
<span class="s2">with iterative reassignments to generate null distribution. All nulls are</span>
<span class="s2">&quot;perfect&quot; permutations of the input data (at the slight expense of spatial</span>
<span class="s2">topology)</span>

<span class="s2">Parameters</span>
<span class="s2">----------</span>
<span class="si">{data_or_none_parcel}</span>
<span class="si">{atlas_density_surface}</span>
<span class="si">{parcellation}</span>
<span class="si">{n_perm}</span>
<span class="si">{seed}</span>
<span class="si">{spins}</span>
<span class="si">{surfaces}</span>

<span class="s2">Returns</span>
<span class="s2">-------</span>
<span class="si">{nulls}</span>

<span class="s2">References</span>
<span class="s2">----------</span>
<span class="s2">.. [SN2] Váša, F., Seidlitz, J., Romero-Garcia, R., Whitaker, K. J.,</span>
<span class="s2">   Rosenthal, G., Vértes, P. E., ... &amp; Jones, P. B. (2018). Adolescent</span>
<span class="s2">   tuning of association cortex in human structural brain networks.</span>
<span class="s2">   Cerebral Cortex, 28(1), 281-294.</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">_nulls_input_docs</span><span class="p">)</span>


<div class="viewcode-block" id="hungarian"><a class="viewcode-back" href="../../../generated/neuromaps.nulls.hungarian.html#neuromaps.nulls.hungarian">[docs]</a><span class="k">def</span> <span class="nf">hungarian</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="s1">&#39;fsaverage&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="s1">&#39;10k&#39;</span><span class="p">,</span> <span class="n">parcellation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">n_perm</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">surfaces</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">parcellation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot use `hungarian()` null method without &#39;</span>
                         <span class="s1">&#39;specifying a parcellation. Use `alexander_bloch() &#39;</span>
                         <span class="s1">&#39;instead if working with unparcellated surface data.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">surfaces</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">surfaces</span> <span class="o">=</span> <span class="n">fetch_atlas</span><span class="p">(</span><span class="n">atlas</span><span class="p">,</span> <span class="n">density</span><span class="p">)[</span><span class="s1">&#39;sphere&#39;</span><span class="p">]</span>
        <span class="n">coords</span><span class="p">,</span> <span class="n">hemi</span> <span class="o">=</span> <span class="n">get_parcel_centroids</span><span class="p">(</span><span class="n">surfaces</span><span class="p">,</span>
                                            <span class="n">parcellation</span><span class="o">=</span><span class="n">parcellation</span><span class="p">,</span>
                                            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;surface&#39;</span><span class="p">)</span>
        <span class="n">spins</span> <span class="o">=</span> <span class="n">gen_spinsamples</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">hemi</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;hungarian&#39;</span><span class="p">,</span>
                                <span class="n">n_rotate</span><span class="o">=</span><span class="n">n_perm</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">spins</span> <span class="o">=</span> <span class="n">load_spins</span><span class="p">(</span><span class="n">spins</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spins</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">load_data</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="n">spins</span><span class="p">]</span></div>


<span class="n">hungarian</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Generates null maps for parcellated `data` using the Hungarian method ([SN3]_)</span>

<span class="s2">Method projects parcels to a spherical surface and uses arbitrary rotations</span>
<span class="s2">with reassignments based on optimization via the Hungarian method to generate</span>
<span class="s2">null distribution. All nulls are &quot;perfect&quot; permutations of the input data (at</span>
<span class="s2">the slight expense of spatial topology)</span>

<span class="s2">Parameters</span>
<span class="s2">----------</span>
<span class="si">{data_or_none_parcel}</span>
<span class="si">{atlas_density_surface}</span>
<span class="si">{parcellation}</span>
<span class="si">{n_perm}</span>
<span class="si">{seed}</span>
<span class="si">{spins}</span>
<span class="si">{surfaces}</span>

<span class="s2">Returns</span>
<span class="s2">-------</span>
<span class="si">{nulls}</span>

<span class="s2">References</span>
<span class="s2">----------</span>
<span class="s2">.. [SN3] Kuhn, H. W. (1955). The Hungarian method for the assignment problem.</span>
<span class="s2">   Naval Research Logistics Quarterly, 2(1‐2), 83-97.</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">_nulls_input_docs</span><span class="p">)</span>


<div class="viewcode-block" id="baum"><a class="viewcode-back" href="../../../generated/neuromaps.nulls.baum.html#neuromaps.nulls.baum">[docs]</a><span class="k">def</span> <span class="nf">baum</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="s1">&#39;fsaverage&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="s1">&#39;10k&#39;</span><span class="p">,</span> <span class="n">parcellation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
         <span class="n">n_perm</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">surfaces</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">parcellation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot use `baum()` null method without specifying &#39;</span>
                         <span class="s1">&#39;a parcellation. Use `alexander_bloch() instead if &#39;</span>
                         <span class="s1">&#39;working with unparcellated surface data.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">surfaces</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">surfaces</span> <span class="o">=</span> <span class="n">fetch_atlas</span><span class="p">(</span><span class="n">atlas</span><span class="p">,</span> <span class="n">density</span><span class="p">)[</span><span class="s1">&#39;sphere&#39;</span><span class="p">]</span>
    <span class="n">spins</span> <span class="o">=</span> <span class="n">spin_parcels</span><span class="p">(</span><span class="n">surfaces</span><span class="p">,</span> <span class="n">parcellation</span><span class="p">,</span>
                         <span class="n">n_rotate</span><span class="o">=</span><span class="n">n_perm</span><span class="p">,</span> <span class="n">spins</span><span class="o">=</span><span class="n">spins</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spins</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">nulls</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">spins</span><span class="p">]</span>
    <span class="n">nulls</span><span class="p">[</span><span class="n">spins</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">nulls</span></div>


<span class="n">baum</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Generates null maps for parcellated `data` using method from [SN4]_</span>

<span class="s2">Method projects `data` to spherical surface and uses arbitrary rotations to</span>
<span class="s2">generate null distributions. Reassigned parcels are based on the most common</span>
<span class="s2">(i.e., modal) value of the vertices in each parcel within the the rotated data</span>

<span class="s2">Parameters</span>
<span class="s2">----------</span>
<span class="si">{data_or_none_parcel}</span>
<span class="si">{atlas_density_surface}</span>
<span class="si">{parcellation}</span>
<span class="si">{n_perm}</span>
<span class="si">{seed}</span>
<span class="si">{spins}</span>
<span class="si">{surfaces}</span>

<span class="s2">Returns</span>
<span class="s2">-------</span>
<span class="si">{nulls}</span>

<span class="s2">References</span>
<span class="s2">----------</span>
<span class="s2">.. [SN4] Baum, G. L., Cui, Z., Roalf, D. R., Ciric, R., Betzel, R. F., Larsen,</span>
<span class="s2">   B., ... &amp; Satterthwaite, T. D. (2020). Development of structure–function</span>
<span class="s2">   coupling in human brain networks during youth. Proceedings of the National</span>
<span class="s2">   Academy of Sciences, 117(1), 771-778.</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">_nulls_input_docs</span><span class="p">)</span>


<div class="viewcode-block" id="cornblath"><a class="viewcode-back" href="../../../generated/neuromaps.nulls.cornblath.html#neuromaps.nulls.cornblath">[docs]</a><span class="k">def</span> <span class="nf">cornblath</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="s1">&#39;fsaverage&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="s1">&#39;10k&#39;</span><span class="p">,</span> <span class="n">parcellation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">n_perm</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">surfaces</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">parcellation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot use `cornblath()` null method without &#39;</span>
                         <span class="s1">&#39;specifying a parcellation. Use `alexander_bloch() &#39;</span>
                         <span class="s1">&#39;instead if working with unparcellated surface data.&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">surfaces</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">surfaces</span> <span class="o">=</span> <span class="n">fetch_atlas</span><span class="p">(</span><span class="n">atlas</span><span class="p">,</span> <span class="n">density</span><span class="p">)[</span><span class="s1">&#39;sphere&#39;</span><span class="p">]</span>
    <span class="n">nulls</span> <span class="o">=</span> <span class="n">spin_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">surfaces</span><span class="p">,</span> <span class="n">parcellation</span><span class="p">,</span>
                      <span class="n">n_rotate</span><span class="o">=</span><span class="n">n_perm</span><span class="p">,</span> <span class="n">spins</span><span class="o">=</span><span class="n">spins</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nulls</span></div>


<span class="n">cornblath</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Generates null maps for parcellated `data` using method from [SN5]_</span>

<span class="s2">Method projects `data` to spherical surface and uses arbitrary rotations to</span>
<span class="s2">generate null distributions. Reassigned parcels are based on the average value</span>
<span class="s2">of the vertices in each parcel within the rotated data</span>

<span class="s2">Parameters</span>
<span class="s2">----------</span>
<span class="si">{data_parcel}</span>
<span class="si">{atlas_density_surface}</span>
<span class="si">{parcellation}</span>
<span class="si">{n_perm}</span>
<span class="si">{seed}</span>
<span class="si">{spins}</span>
<span class="si">{surfaces}</span>

<span class="s2">Returns</span>
<span class="s2">-------</span>
<span class="si">{nulls}</span>

<span class="s2">References</span>
<span class="s2">----------</span>
<span class="s2">.. [SN5] Cornblath, E. J., Ashourvan, A., Kim, J. Z., Betzel, R. F., Ciric, R.,</span>
<span class="s2">   Adebimpe, A., ... &amp; Bassett, D. S. (2020). Temporal sequences of brain</span>
<span class="s2">   activity at rest are constrained by white matter structure and modulated by</span>
<span class="s2">   cognitive demands. Communications biology, 3(1), 1-12.</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">_nulls_input_docs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_distmat</span><span class="p">(</span><span class="n">hemisphere</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="s1">&#39;fsaverage&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="s1">&#39;10k&#39;</span><span class="p">,</span>
                 <span class="n">parcellation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">hemi</span> <span class="o">=</span> <span class="n">HEMI</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hemisphere</span><span class="p">,</span> <span class="n">hemisphere</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hemi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid hemishere designation </span><span class="si">{</span><span class="n">hemisphere</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">drop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">drop</span> <span class="o">=</span> <span class="n">PARCIGNORE</span>

    <span class="n">atlas</span> <span class="o">=</span> <span class="n">fetch_atlas</span><span class="p">(</span><span class="n">atlas</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
    <span class="n">surf</span><span class="p">,</span> <span class="n">medial</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;pial&#39;</span><span class="p">],</span> <span class="n">hemi</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;medial&#39;</span><span class="p">],</span> <span class="n">hemi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parcellation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">get_surface_distance</span><span class="p">(</span><span class="n">surf</span><span class="p">,</span> <span class="n">medial</span><span class="o">=</span><span class="n">medial</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">get_surface_distance</span><span class="p">(</span><span class="n">surf</span><span class="p">,</span> <span class="n">parcellation</span><span class="o">=</span><span class="n">parcellation</span><span class="p">,</span>
                                    <span class="n">medial_labels</span><span class="o">=</span><span class="n">drop</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="n">drop</span><span class="p">,</span>
                                    <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dist</span>


<span class="n">_get_distmat</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Generates surface distance matrix for specified `hemisphere`</span>

<span class="s2">If `parcellation` is provided then the returned distance matrix will be a</span>
<span class="s2">parcel-parcel matrix.</span>

<span class="s2">Parameters</span>
<span class="s2">----------</span>
<span class="s2">hemisphere : {{&#39;L&#39;, &#39;R&#39;}}</span>
<span class="s2">    Hemisphere of surface from which to generate distance matrix</span>
<span class="si">{atlas_density_surface}</span>
<span class="si">{parcellation}</span>
<span class="s2">drop : list-of-str, optional</span>
<span class="s2">    If `parcellation` is not None, which parcels should be ignored / dropped</span>
<span class="s2">    from the generate distance matrix. If not specified will ignore parcels</span>
<span class="s2">    generally indicative of the medial wall. Default: None</span>
<span class="si">{n_proc}</span>

<span class="s2">Returns</span>
<span class="s2">-------</span>
<span class="s2">dist : (N, N) np.ndarray</span>
<span class="s2">    Surface distance matrix between vertices. If a `parcellation` is specified</span>
<span class="s2">    then this will be the parcel-parcel distance matrix, where the distance</span>
<span class="s2">    between parcels is the average distance between all constituent vertices</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">_nulls_input_docs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_surf_surrogates</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">atlas</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">parcellation</span><span class="p">,</span> <span class="n">distmat</span><span class="p">,</span> <span class="n">n_proc</span><span class="p">):</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">parcellation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">parcellation</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">hemi</span><span class="p">,</span> <span class="n">parc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">((</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">),</span> <span class="n">parcellation</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">distmat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">_get_distmat</span><span class="p">(</span><span class="n">hemi</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="n">atlas</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="n">density</span><span class="p">,</span>
                                <span class="n">parcellation</span><span class="o">=</span><span class="n">parc</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">distmat</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">parc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trim_zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">load_data</span><span class="p">(</span><span class="n">parc</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">hdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">dist</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">)))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">hdata</span><span class="p">),</span> <span class="n">med</span><span class="p">))</span>

        <span class="k">yield</span> <span class="n">hdata</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">dist</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">)],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_vol_surrogates</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">atlas</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">parcellation</span><span class="p">,</span> <span class="n">distmat</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">atlas</span> <span class="o">!=</span> <span class="s1">&#39;MNI152&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot compute volumetric surrogates if atlas is &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;not &quot;MNI152&quot;. Received: </span><span class="si">{</span><span class="n">atlas</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">parcellation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;`data` must be array_like and represent a &#39;</span>
                   <span class="s1">&#39;parcellated brain map when `parcellation` is not &#39;</span>
                   <span class="s1">&#39;&quot;None&quot;&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Brain map must be one-dimensional. Got shape &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">atlas</span> <span class="o">=</span> <span class="n">fetch_atlas</span><span class="p">(</span><span class="n">atlas</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>

    <span class="c1"># get data + coordinates of valid datapoints</span>
    <span class="k">if</span> <span class="n">parcellation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">darr</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;2009cAsym_T1w&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">darr</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="n">bmask</span> <span class="o">=</span> <span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;2009cAsym_brainmask&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">density</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1mm&#39;</span><span class="p">,</span> <span class="s1">&#39;2mm&#39;</span><span class="p">)</span>
              <span class="ow">and</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;6Asym_T1w&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">darr</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
            <span class="n">bmask</span> <span class="o">=</span> <span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;6Asym_brainmask&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bmask</span> <span class="o">=</span> <span class="n">mni152_to_mni152</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">atlas</span><span class="p">[</span><span class="s1">&#39;2009cAsym_brainmask&#39;</span><span class="p">]),</span>
                                     <span class="n">data</span><span class="p">,</span>
                                     <span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="n">darr</span> <span class="o">*=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">bmask</span><span class="p">)</span>
        <span class="n">affine</span> <span class="o">=</span> <span class="n">load_nifti</span><span class="p">(</span><span class="n">bmask</span><span class="p">)</span><span class="o">.</span><span class="n">affine</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">darr</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">parcellation</span><span class="p">)</span>
        <span class="n">affine</span> <span class="o">=</span> <span class="n">load_nifti</span><span class="p">(</span><span class="n">parcellation</span><span class="p">)</span><span class="o">.</span><span class="n">affine</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trim_zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">darr</span><span class="p">))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">darr</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">darr</span><span class="p">)))</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">affines</span><span class="o">.</span><span class="n">apply_affine</span><span class="p">(</span><span class="n">affine</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">)))</span>

    <span class="c1"># calculate distance matrix</span>
    <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">distmat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">parcellation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># memmap because BIG</span>
            <span class="n">distout</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.mmap&#39;</span><span class="p">)</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">distout</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span>
                             <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)))</span>
            <span class="n">indout</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.mmap&#39;</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">indout</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span>
                              <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyz</span><span class="p">):</span>
                <span class="n">xyz_dist</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">xyz</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
                <span class="n">index</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">xyz_dist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
                <span class="n">dist</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyz_dist</span><span class="p">[:,</span> <span class="n">index</span><span class="p">[</span><span class="n">n</span><span class="p">]]</span>
                <span class="n">dist</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">index</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parcellation</span> <span class="o">=</span> <span class="n">darr</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">row_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyz</span><span class="p">):</span>
                <span class="n">xyz_dist</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">xyz</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
                <span class="n">row_dist</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xyz_dist</span><span class="p">,</span> <span class="n">parcellation</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)):</span>
                <span class="n">dist</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">row_dist</span><span class="p">[:,</span> <span class="n">n</span><span class="p">],</span> <span class="n">parcellation</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">distmat</span>
        <span class="k">if</span> <span class="n">parcellation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">parcellation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">darr</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">dist</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">mask</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">data</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_make_surrogates</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="s1">&#39;fsaverage&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="s1">&#39;10k&#39;</span><span class="p">,</span>
                     <span class="n">parcellation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_perm</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">distmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">n_proc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;burt2018&#39;</span><span class="p">,</span> <span class="s1">&#39;burt2020&#39;</span><span class="p">,</span> <span class="s1">&#39;moran&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid null method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">atlas</span> <span class="o">=</span> <span class="n">_sanitize_atlas</span><span class="p">(</span><span class="n">atlas</span><span class="p">)</span>
    <span class="n">darr</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">surrogates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">darr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_perm</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">genfunc</span> <span class="o">=</span> <span class="n">_vol_surrogates</span> <span class="k">if</span> <span class="n">atlas</span> <span class="o">==</span> <span class="s1">&#39;MNI152&#39;</span> <span class="k">else</span> <span class="n">_surf_surrogates</span>
    <span class="k">for</span> <span class="n">hdata</span><span class="p">,</span> <span class="n">hdist</span><span class="p">,</span> <span class="n">hind</span><span class="p">,</span> <span class="n">hsl</span> <span class="ow">in</span> <span class="n">genfunc</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">atlas</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span>
                                           <span class="n">parcellation</span><span class="p">,</span> <span class="n">distmat</span><span class="p">,</span>
                                           <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;burt2018&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parcellation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">hind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">hdist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span>
                        <span class="n">hdist</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">hind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">hdata</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">darr</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.1</span>
            <span class="n">hsurr</span> <span class="o">=</span> <span class="n">batch_surrogates</span><span class="p">(</span><span class="n">hdist</span><span class="p">,</span> <span class="n">hdata</span><span class="p">,</span> <span class="n">n_surr</span><span class="o">=</span><span class="n">n_perm</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;burt2020&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parcellation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">hind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">hind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">hdist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">hdist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">hdist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">hsurr</span> <span class="o">=</span> <span class="n">Sampled</span><span class="p">(</span><span class="n">hdata</span><span class="p">,</span> <span class="n">hdist</span><span class="p">,</span> <span class="n">hind</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span>
                                <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)(</span><span class="n">n_perm</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hsurr</span> <span class="o">=</span> <span class="n">Base</span><span class="p">(</span><span class="n">hdata</span><span class="p">,</span> <span class="n">hdist</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)(</span><span class="n">n_perm</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="k">if</span> <span class="n">hsurr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">hsurr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">hsurr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># clean up (FIXME: this is ugly and we should fix it)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hdist</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span><span class="p">):</span>
                <span class="n">hdist</span><span class="o">.</span><span class="n">_mmap</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">hind</span><span class="o">.</span><span class="n">_mmap</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">hdist</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">hind</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">hdist</span><span class="p">,</span> <span class="n">hind</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;moran&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parcellation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">hind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">hdist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span>
                        <span class="n">hdist</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">hind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">hdist</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dist</span> <span class="o">**=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">joint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">n_rep</span><span class="o">=</span><span class="n">n_perm</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">mrs</span> <span class="o">=</span> <span class="n">MoranRandomization</span><span class="p">(</span><span class="o">**</span><span class="n">opts</span><span class="p">)</span>
            <span class="n">hsurr</span> <span class="o">=</span> <span class="n">mrs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="o">.</span><span class="n">randomize</span><span class="p">(</span><span class="n">hdata</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="n">surrogates</span><span class="p">[</span><span class="n">hsl</span><span class="p">]</span> <span class="o">=</span> <span class="n">hsurr</span>

    <span class="k">return</span> <span class="n">surrogates</span>


<span class="n">_make_surrogates</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Generates null surrogates for specified `data` using `method`</span>

<span class="s2">Parameters</span>
<span class="s2">----------</span>
<span class="si">{data}</span>
<span class="s2">method : {{&#39;burt2018&#39;, &#39;burt2020&#39;, &#39;moran&#39;}}</span>
<span class="s2">    Method by which to generate null surrogates</span>
<span class="si">{atlas_density}</span>
<span class="si">{parcellation}</span>
<span class="si">{n_perm}</span>
<span class="si">{seed}</span>
<span class="si">{distmat}</span>
<span class="si">{n_proc}</span>
<span class="si">{kwargs}</span>

<span class="s2">Returns</span>
<span class="s2">-------</span>
<span class="si">{nulls}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">_nulls_input_docs</span><span class="p">)</span>


<div class="viewcode-block" id="burt2018"><a class="viewcode-back" href="../../../generated/neuromaps.nulls.burt2018.html#neuromaps.nulls.burt2018">[docs]</a><span class="k">def</span> <span class="nf">burt2018</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="s1">&#39;fsaverage&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="s1">&#39;10k&#39;</span><span class="p">,</span> <span class="n">parcellation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">n_perm</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">distmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_make_surrogates</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;burt2018&#39;</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="n">atlas</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="n">density</span><span class="p">,</span>
                            <span class="n">parcellation</span><span class="o">=</span><span class="n">parcellation</span><span class="p">,</span> <span class="n">n_perm</span><span class="o">=</span><span class="n">n_perm</span><span class="p">,</span>
                            <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span> <span class="n">distmat</span><span class="o">=</span><span class="n">distmat</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="n">burt2018</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Generates null maps for `data` using method from [SN6]_</span>

<span class="s2">Method uses a spatial auto-regressive model to estimate distance-dependent</span>
<span class="s2">relationship of `data` and generates surrogate maps with similar properties</span>

<span class="s2">Parameters</span>
<span class="s2">----------</span>
<span class="si">{data}</span>
<span class="si">{atlas_density}</span>
<span class="si">{parcellation}</span>
<span class="si">{n_perm}</span>
<span class="si">{seed}</span>
<span class="si">{distmat}</span>
<span class="si">{kwargs}</span>

<span class="s2">Returns</span>
<span class="s2">-------</span>
<span class="si">{nulls}</span>

<span class="s2">References</span>
<span class="s2">----------</span>
<span class="s2">.. [SN6] Burt, J. B., Demirtaş, M., Eckner, W. J., Navejar, N. M., Ji, J. L.,</span>
<span class="s2">   Martin, W. J., ... &amp; Murray, J. D. (2018). Hierarchy of transcriptomic</span>
<span class="s2">   specialization across human cortex captured by structural neuroimaging</span>
<span class="s2">   topography. Nature Neuroscience, 21(9), 1251-1259.</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">_nulls_input_docs</span><span class="p">)</span>


<div class="viewcode-block" id="burt2020"><a class="viewcode-back" href="../../../generated/neuromaps.nulls.burt2020.html#neuromaps.nulls.burt2020">[docs]</a><span class="k">def</span> <span class="nf">burt2020</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="s1">&#39;fsaverage&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="s1">&#39;10k&#39;</span><span class="p">,</span> <span class="n">parcellation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">n_perm</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">distmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_brainsmash_avail</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;Cannot run burt2020 null model when `brainsmash` &#39;</span>
                          <span class="s1">&#39;is not installed. Please `pip install brainsmash` &#39;</span>
                          <span class="s1">&#39;and try again.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">brainsmash</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;0.10.0&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;The burt2020 null model needs version &gt;= 0.10.0 of &#39;</span>
                          <span class="s1">&#39;`brainsmash. Please `pip install brainsmash`&#39;</span>
                          <span class="s1">&#39;`--upgrade` and try again.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_make_surrogates</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;burt2020&#39;</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="n">atlas</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="n">density</span><span class="p">,</span>
                            <span class="n">parcellation</span><span class="o">=</span><span class="n">parcellation</span><span class="p">,</span> <span class="n">n_perm</span><span class="o">=</span><span class="n">n_perm</span><span class="p">,</span>
                            <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span> <span class="n">distmat</span><span class="o">=</span><span class="n">distmat</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="n">burt2020</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Generates null maps for `data` using method from [SN7]_ and [SN8]_</span>

<span class="s2">Method uses variograms to estimate spatial autocorrelation of `data` and</span>
<span class="s2">generates surrogate maps with similar variogram properties</span>

<span class="s2">Parameters</span>
<span class="s2">----------</span>
<span class="si">{data}</span>
<span class="si">{atlas_density}</span>
<span class="si">{parcellation}</span>
<span class="si">{n_perm}</span>
<span class="si">{seed}</span>
<span class="si">{n_proc}</span>
<span class="si">{distmat}</span>
<span class="si">{kwargs}</span>

<span class="s2">Returns</span>
<span class="s2">-------</span>
<span class="si">{nulls}</span>

<span class="s2">References</span>
<span class="s2">----------</span>
<span class="s2">.. [SN7] Burt, J. B., Helmer, M., Shinn, M., Anticevic, A., &amp; Murray, J. D.</span>
<span class="s2">   (2020). Generative modeling of brain maps with spatial autocorrelation.</span>
<span class="s2">   NeuroImage, 220, 117038.</span>
<span class="s2">.. [SN8] https://github.com/murraylab/brainsmash</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">_nulls_input_docs</span><span class="p">)</span>


<div class="viewcode-block" id="moran"><a class="viewcode-back" href="../../../generated/neuromaps.nulls.moran.html#neuromaps.nulls.moran">[docs]</a><span class="k">def</span> <span class="nf">moran</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="s1">&#39;fsaverage&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="s1">&#39;10k&#39;</span><span class="p">,</span> <span class="n">parcellation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
          <span class="n">n_perm</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">distmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_brainspace_avail</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;Cannot run moran null model when `brainspace` is &#39;</span>
                          <span class="s1">&#39;not installed. Please `pip install brainspace` and &#39;</span>
                          <span class="s1">&#39;try again.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_make_surrogates</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;moran&#39;</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="n">atlas</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="n">density</span><span class="p">,</span>
                            <span class="n">parcellation</span><span class="o">=</span><span class="n">parcellation</span><span class="p">,</span> <span class="n">n_perm</span><span class="o">=</span><span class="n">n_perm</span><span class="p">,</span>
                            <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">,</span> <span class="n">distmat</span><span class="o">=</span><span class="n">distmat</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="n">moran</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Generates null maps for `data` using method from [SN9]_</span>

<span class="s2">Method uses a spatial decomposition of a distance-based weight matrix to</span>
<span class="s2">estimate eigenvectors that are used to generate surrogate maps by imposing a</span>
<span class="s2">similar spatial structure on randomized data. For a MATLAB implementation</span>
<span class="s2">refer to [SN10]_ and [SN11]_</span>

<span class="s2">Parameters</span>
<span class="s2">----------</span>
<span class="si">{data}</span>
<span class="si">{atlas_density}</span>
<span class="si">{parcellation}</span>
<span class="si">{n_perm}</span>
<span class="si">{seed}</span>
<span class="si">{n_proc}</span>
<span class="si">{distmat}</span>
<span class="si">{kwargs}</span>

<span class="s2">Returns</span>
<span class="s2">-------</span>
<span class="si">{nulls}</span>

<span class="s2">References</span>
<span class="s2">----------</span>
<span class="s2">.. [SN9] Wagner, H. H., &amp; Dray, S. (2015). Generating spatially constrained</span>
<span class="s2">   null models for irregularly spaced data using M oran spectral randomization</span>
<span class="s2">   methods. Methods in Ecology and Evolution, 6(10), 1169-1178.</span>
<span class="s2">.. [SN10] de Wael, R. V., Benkarim, O., Paquola, C., Lariviere, S., Royer, J.,</span>
<span class="s2">   Tavakol, S., ... &amp; Bernhardt, B. C. (2020). BrainSpace: a toolbox for the</span>
<span class="s2">   analysis of macroscale gradients in neuroimaging and connectomics datasets.</span>
<span class="s2">   Communications Biology, 3(1), 1-10.</span>
<span class="s2">.. [SN11] https://github.com/MICA-MNI/BrainSpace/</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">_nulls_input_docs</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, neuromaps developers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>